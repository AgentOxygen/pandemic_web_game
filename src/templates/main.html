<html>
<head>
	<style>
	.borderexample {
		border-style:solid;
		border-color:#287EC7;
	}
	</style>
	<script>
	// Settings
	var domain = document.location;
	var user_id = null, user_dn = null, user_logins = null, user_game_code = null, user_game_instance = null;
	var update_delay = 1000;
	
	// Global Variables
	var continue_updating = true;
	var control_update = true;
	
	function login(){
		var login_id = document.getElementById('input_login_id').value;
		var url = (domain + "login?id=" + login_id);
		if (login_id == ""){
			alert("Please enter a valid login ID");
			return false;
		}

		fetch(url).then(function(response) {
			return response.text().then(function(user_info) {
				if (user_info != "no_login"){
					user_info = JSON.parse(user_info);
					user_dn = user_info["display_name"];
					user_id = login_id;
					user_logins = user_info["logins"];
					user_game_instance = user_info["game_instance"];
					console.log(user_info);
					exit_login_pane();
				}else{
					alert("Login ID does not exist.");
					return false;
				}
			});
		});
		return true;
	}
	
	function create_login(){
		var login_id = document.getElementById('input_login_id').value;
		var login_dn = document.getElementById('input_login_dn').value;
		var url = (domain + "createlogin?id=" + login_id + "&dn=" + login_dn);
		if (login_id == ""){
			alert("Please enter a valid login ID");
			return false;
		}
		if (login_dn == ""){
			alert("Please enter a valid display name");
			return false;
		}
		
		fetch(url).then(function(response) {
			return response.text().then(function(user_info) {
				if (user_info != "no_login"){
					user_info = JSON.parse(user_info);
					user_dn = user_info["display_name"];
					user_id = login_id;
					user_logins = user_info["logins"];
					user_game_instance = user_info["game_instance"];
					console.log(user_info);
					exit_login_pane();
				}else{
					alert("Login info creation failed!");
					return false;
				}
			});
		});
		return true;
	}
	
	function exit_login_pane(){
		document.getElementById('login_pane').style.display = "none";
		document.getElementById('init_menu_pane').style.display = "inline";
		document.getElementById('init_menu_user_dn').innerHTML = user_dn;
	}
	
	function join_game(game_code=null){
		if (game_code == null){
			game_code = document.getElementById('input_game_code').value;
		}
		if (game_code == ""){
			alert("Please enter a valid game code.");
			return false;
		}
		fetch(domain + "joingame?code=" + game_code + "&id=" + user_id).then(function(response) {
			return response.text().then(function(response_msg) {
				if (response_msg == game_code || response_msg == "joined"){
					user_game_code = game_code
					if (control_update){
						control_update = false;
						game_update_loop();
					}
				}else if(response_msg == "max_players"){
					alert("Max players in game code " + game_code);
				}else{
					alert("Response message: " + response_msg);
				}
			});
		});
		return true;
	}
	
	function host_game(){
		document.getElementById('button_host_start_game').style.display = "inline";
		fetch(domain + "creategame?id=" + user_id).then(function(response) {
			return response.text().then(function(game_code) {
				join_game(game_code);
			});
		});
	}
	
	function leave_game(){
		
	}
	
	function host_start_game(){
		
	}
	
	function delay(time) {
		return new Promise(resolve => setTimeout(resolve, time));
	}
	
	async function game_update_loop(){
		document.getElementById('lobby_pane').style.display = "inline";
		document.getElementById('init_menu_pane').style.display = "none";
		document.getElementById('text_game_code').innerHTML = user_game_code;
		
		while (continue_updating) {
			fetch(domain + "getgame?code=" + user_game_code).then(function(response) {
				return response.text().then(function(instance_info) {
					instance_info = JSON.parse(instance_info);
					if (instance_info["stage"] == "in_game"){
						if(document.getElementById('lobby_pane').style.display == "inline"){
							document.getElementById('lobby_pane').style.display = "none";
							document.getElementById('in_game_pane').style.display = "inline";
						}
					}else{
						document.getElementById('text_players').innerHTML = "<u>Players</u>";
						for (player of instance_info["players"]){
							var suffix = "";
							if (instance_info["host"] == user_id && player[0] != user_id){
								suffix = "<button onclick='game_kick(" + player[0] + ")'> Kick </button>";
							}else if (player[0] == user_id){
								suffix = " (Me)";
							}
							document.getElementById('text_players').innerHTML += "<br>" + player[1] + suffix;
						}
					}
					
				});
			});
			await delay(update_delay);
		}
	}
	
	/* Async update example
	function delay(time) {
		return new Promise(resolve => setTimeout(resolve, time));
	}	
	
	async function update_chat(){
		let timer = 0;
		while (true) {
			fetch(domain + "/chat").then(function(response) {
				return response.text().then(function(chat_str) {
					document.getElementById('text_output_chat').innerHTML = chat_str;
				});
			});
			await delay(1000);
		}
	}
	
	function send_chat(){
		msg = "[" + user_dn + "] " + document.getElementById('input_chat').value;
		fetch(domain + "/sendchat?msg=" + msg).then(function(response) {
			return response.text().then(function(chat_str) {});
		});
	}
	*/
	
	
	</script>
</head>
<body>
<div id="login_pane">
	Login ID: <input id="input_login_id"> </br>
	Display Name: <input id="input_login_dn"> </br>
	<button id="button_login" onclick="login()"> Login </button>
	<button id="button_create_login" onclick="create_login()"> Create Login </button>
</div>
<div id="init_menu_pane" style="display: none">
	<h2>Hello <span id="init_menu_user_dn" style="font-style: italic;"> </span>,</h2> <br>
	<p style="margin-left: 40px">Game Code: <input id="input_game_code"></p>
	<p style="margin-left: 40px"><button id="button_game_join" onclick="join_game()"> Join Game </button></p>
	<p style="margin-left: 40px"><button id="button_game_host" onclick="host_game()"> Host Game </button></p>
</div>
<div id="lobby_pane" style="display: none">
	<h2>Game Code: <span id="text_game_code"></span></h2>
	<div id ="text_players" style="height:280px;width:420px;border:2px solid #ccc;font:26px/46px Georgia, Garamond, Serif;overflow:auto;"></div>
	<button id="button_host_start_game" onclick="host_start_game()" style="display: none"> Start Game </button>
	<button id="button_leave_game" onclick="leave_game()"> Leave Game </button>
</div>



</body>
</html>